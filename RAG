'''Reiseplaner anhand weniger Informationen wie Reisedauer und Destination.
Unter BerÃ¼cksichtigung des Wetters soll die bestmÃ¶gliche Gestaltung der Reise garantiert werden.'''

import os
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

# LLM anlegen (explicit api_key + base_url fÃ¼r Cerebras)
llm = ChatOpenAI(
    api_key=os.environ["CEREBRAS_TOKEN"],
    base_url="https://api.cerebras.ai/v1",
    model="llama3.1-8b",
    temperature=0.4,   # eher strukturiert
)

from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder

#rag_prompt = ChatPromptTemplate.from_messages([
rag_prompt = ChatPromptTemplate.from_messages([
    ("system",
     "Du bist ein Reiseplaner. Erstelle klare, realistische TagesplÃ¤ne in Deutsch. "
     "BerÃ¼cksichtige Reisedauer, Reiseziel und Interessen. "
     "Formatiere so:\n"
     "Tag 1 â€“ Morgen: ...\nNachmittag: ...\nAbend: ...\n"
     "Kurze BegrÃ¼ndungen, sinnvolle Reihenfolge, realistische Dauer.\n\n"
     "Am Ende deiner Antwort sollst du die Quellen angeben, die du fÃ¼r deine Antwort verwendet hast. "
     "Wenn du keine Quellen hast, schreibe 'Keine Quellen'.\n\n"
     "Du bist ein Reiseplaner ... "
     "Nutze ausschlieÃŸlich Informationen aus dem folgenden Kontext. "
     "Die Quellen sind am Anfang jedes Abschnitts angegeben. "
     "Zitiere nur diese Quellen und keine anderen. "
     "Wenn keine Quelle angegeben ist, schreibe 'Keine Quelle'.\n\n"
     "Context:\n{context}"),
    ("human", "Plane {days} Tage in {city}. Interessen: {interests}.")
])

# Chain: Prompt â†’ LLM â†’ OutputParser
rag_chain = rag_prompt | llm | StrOutputParser()


import os
from langchain_community.document_loaders import WebBaseLoader

# User-Agent setzen (wichtig fÃ¼r einige Websites)
os.environ["USER_AGENT"] = "Mozilla/5.0 (compatible; MyLangChainBot/1.0; +https://example.com/bot)"

# Mehrere Webseiten laden
loader_multiple_pages = WebBaseLoader(
    [
        "https://de.wikivoyage.org/wiki/Kopenhagen",
        "https://de.wikivoyage.org/wiki/Madrid",
    ]
)

websites = loader_multiple_pages.load()

print(f"Loaded {len(websites)} documents from {len(loader_multiple_pages.web_paths)} websites.")


#Splitter
from langchain_text_splitters import RecursiveCharacterTextSplitter
all_docs = websites

# define the splitter and strategy
splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=100)
splits = splitter.split_documents(all_docs)


import numpy as np

lengths = [len(s.page_content) for s in splits]
print(f"Initial documents: {len(all_docs)}")
print(f"Total chunks: {len(splits)}")
print(f"Avg length: {np.mean(lengths):.1f}")
print(f"Min: {np.min(lengths)}, Max: {np.max(lengths)}")


#Embeddings
from langchain.embeddings import HuggingFaceEmbeddings
from langchain.vectorstores import FAISS

embeddings = HuggingFaceEmbeddings(model_name="sentence-transformers/all-MiniLM-L6-v2")

db = FAISS.from_texts(texts, embeddings)
retriever = db.as_retriever(search_kwargs={"k": 2})


# Funktion, um RAG-Kontext aus Retriever zu holen
def build_context(city: str, interests: str, k: int = 4, max_chars: int = 1200) -> str:
    """Erzeugt einen Kontexttext aus dem Retriever fÃ¼r das RAG."""
    query = f"{city} SehenswÃ¼rdigkeiten {interests}"
    try:
        docs = retriever.get_relevant_documents(query, k=k)
        # Falls keine Dokumente gefunden wurden
        if not docs:
            return "Keine passenden Quellen gefunden."
        # Nur Textinhalte zusammenfassen
        parts = []
        for d in docs:
            txt = (d.page_content or "")
            parts.append(txt[:max_chars])
        return "\n\n---\n\n".join(parts)
    except Exception as e:
        return f"Fehler beim Laden des Kontextes: {e}"
    

def plan_trip(city: str, days: int, interests: str) -> str:
    """Erzeugt einen strukturierten Tagesplan (Use Case 1 â€“ Basis, mit RAG-Kontext)."""
    if not (city and interests):
        return "Bitte Stadt und Interessen angeben."
    try:
        days = int(days)
        if days < 1:
            return "Bitte 'days' als positive Zahl angeben."
    except Exception:
        return "Bitte 'days' als ganze Zahl angeben."

    # ğŸ‘‰ RAG: Kontext holen
    context = build_context(city.strip(), interests.strip())

    # Prompt-Variablen vollstÃ¤ndig Ã¼bergeben (inkl. `context`)
    return rag_chain.invoke({
        "city": city.strip(),
        "days": days,
        "interests": interests.strip(),
        "context": context
    })


print(plan_trip("Madrid", 4, "Essen"))